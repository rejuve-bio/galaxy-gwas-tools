<?xml version="1.0"?>
<tool id="gwas_harmonizer_setup" name="GWAS Harmonizer Setup" version="1.1.0">
    <description>Prepare reference data for GWAS harmonization using a portable Nextflow environment</description>

    <requirements>
        <requirement type="package">python</requirement>
        <requirement type="package">curl</requirement>
        <requirement type="package">git</requirement>
    </requirements>

    <command detect_errors="exit_code">
        <![CDATA[
        python $__tool_directory__/harmonizer_setup_wrapper.py 
            --code-repo "${code_repo}" 
            --ref-dir "${ref_dir}" 
            --chromlist "${chromlist}"
        ]]>
    </command>

    <inputs>
        <param name="code_repo" type="text"
               label="Path to harmonizer repository"
               value="/mnt/hdd_1/ofgeha/gwas-sumstats-harmoniser"
               help="Absolute path to the local GWAS harmonizer repository (containing main.nf)"/>

        <param name="ref_dir" type="text"
               label="Reference data directory (absolute path)"
               value="/mnt/hdd_1/ofgeha/gwas-sumstats-harmoniser/gwas-ref"
               help="Writable directory for storing reference data files"/>

        <param name="chromlist" type="text"
               label="Chromosome list"
               value="1,2,3,...,22,X,Y,MT"
               help="Comma-separated list of chromosomes to harmonize"/>
    </inputs>

    <outputs>
        <data name="log_dir" format="txt" from_work_dir="log_dir.txt"
              label="Reference setup log directory path"/>
        <data name="report" format="html" from_work_dir="report.html"
              label="Nextflow setup report"/>
        <data name="timeline" format="html" from_work_dir="timeline.html"
              label="Nextflow setup timeline"/>
    </outputs>

    <help><![CDATA[
**GWAS Harmonizer Setup**

This Galaxy tool prepares reference data for the EBISPOT GWAS Harmonizer pipeline.  
It installs local portable Java 17 and Nextflow if they are not already available,  
and executes the reference-building workflow.

### Workflow Steps
1. Validate the harmonizer repository and reference directory.
2. Install or detect Java 17 (locally if missing).
3. Install or detect Nextflow (locally if missing).
4. Run the Nextflow reference workflow with reporting enabled.

### Outputs
- Log directory (path text file)
- Nextflow HTML report
- Nextflow timeline

### Notes
- The setup is fully self-contained and does not require root access.
- Java and Nextflow are installed under the repository directory.
    ]]></help>
</tool>
