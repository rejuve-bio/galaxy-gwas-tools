<?xml version="1.0"?>
<tool id="gwas_harmonizer" name="GWAS Harmonizer" version="1.0.0">
  <description>
    Harmonize GWAS summary statistics using EBISPOT harmonizer
  </description>

  <requirements>
    <requirement type="package" version="3.8">python</requirement>
    <requirement type="package">nextflow</requirement>
    <requirement type="package">git</requirement>
    <requirement type="package">bgzip</requirement>
    <requirement type="package">tabix</requirement>
  </requirements>

  <command detect_errors="exit_code"><![CDATA[
    python3 '$__tool_directory__/gwas_harmonizer.py'
      --input '$sumstats'
      --build '$build'
      --threshold '$threshold'
      --ref-dir '$ref_dir'
      --code-repo '$code_repo'
      --workdir '.'
      #if $min_mac:
      --min-mac '$min_mac'
      #end if
      #if $info_score:
      --info-score '$info_score'
      #end if
  ]]></command>

  <inputs>
    <!-- Input GWAS dataset -->
    <param name="sumstats" type="data" format="txt,tsv,tabular" 
           label="Input GWAS summary statistics"
           help="Upload your GWAS summary statistics file (tab-delimited text)"/>

    <!-- Genome build -->
    <param name="build" type="select" label="Input genome build">
      <option value="GRCh37">GRCh37 (b37/hg19)</option>
      <option value="GRCh38">GRCh38 (b38/hg38)</option>
    </param>

    <!-- Palindromic threshold -->
    <param name="threshold" type="float" value="0.99" min="0.0" max="1.0" 
           label="Palindromic threshold"
           help="Threshold for handling palindromic SNPs (default 0.99)"/>

    <!-- Reference directory -->
    <param name="ref_dir" type="text" value="/mnt/hdd_1/ofgeha/gwas-ref"
           label="Reference directory (absolute path)" 
           help="Absolute path to reference data directory (must be setup first)">
      <validator type="empty_field" message="Reference directory is required"/>
    </param>

    <!-- Code repository path -->
    <param name="code_repo" type="text" value="/mnt/hdd_1/ofgeha/gwas-sumstats-harmoniser"
           label="Harmonizer code repository path"
           help="Absolute path to the harmonizer repository">
      <validator type="empty_field" message="Code repository path is required"/>
    </param>

    <!-- Optional filters -->
    <param name="min_mac" type="float" optional="true" min="0" 
           label="Minimum minor allele count"
           help="Optional: Filter variants by minimum minor allele count"/>
           
    <param name="info_score" type="float" optional="true" min="0" max="1" 
           label="INFO score filter"
           help="Optional: Filter variants by INFO score (0-1)"/>
  </inputs>

  <outputs>
    <!-- Primary harmonized output -->
    <data name="harmonized_output" format="txt" from_work_dir="harmonized_output.txt" 
          label="Harmonized GWAS Data"/>
    
    <!-- SSF converted file -->
    <data name="ssf_output" format="txt" from_work_dir="*.tsv.gz" 
          label="SSF Converted Data"/>
    
    <!-- Metadata file -->
    <data name="metadata" format="yaml" from_work_dir="*.yaml" 
          label="Metadata YAML"/>
    
    <!-- Logs -->
    <data name="harm_log" format="txt" from_work_dir="logs/harm.log" 
          label="Harmonization Log"/>
    
    <data name="harm_report" format="html" from_work_dir="logs/harm-report-*.html" 
          label="Nextflow Harmonization Report"/>
  </outputs>

  <tests>
    <test>
      <param name="sumstats" value="test_gwas_data.txt" ftype="txt"/>
      <param name="build" value="GRCh37"/>
      <param name="threshold" value="0.99"/>
      <param name="ref_dir" value="/mnt/hdd_1/ofgeha/gwas-ref"/>
      <param name="code_repo" value="/mnt/hdd_1/ofgeha/gwas-sumstats-harmoniser"/>
      <output name="harmonized_output" file="harmonized_output.txt" compare="sim_size"/>
    </test>
  </tests>

  <help>
<![CDATA[
**GWAS Harmonizer Tool**

This tool harmonizes GWAS summary statistics using the EBISPOT harmonizer.

**Input Requirements:**
- GWAS summary statistics in tab-delimited format
- Must contain columns: SNP, CHR, BP, A1, A2, and either BETA/SE or OR/OR_95L/OR_95U
- File should have a header row

**Parameters:**
- **Input genome build**: Specify whether your data is in GRCh37 (hg19) or GRCh38 (hg38)
- **Palindromic threshold**: Threshold for handling palindromic SNPs (A/T, C/G)
- **Reference directory**: Absolute path to pre-setup reference data directory
- **Code repository path**: Absolute path to the harmonizer repository

**Optional Parameters:**
- **Minimum MAC**: Optional filter for minor allele count
- **INFO score**: Optional filter for imputation quality

**Outputs:**
- **Harmonized GWAS Data**: Primary harmonized summary statistics
- **SSF Converted Data**: Input data converted to SSF format
- **Metadata YAML**: Metadata file for the harmonized data
- **Execution logs**: Nextflow execution logs and reports

**Note:** The reference directory must be setup first using the "GWAS Harmonizer Setup" tool.
]]>
  </help>
</tool>