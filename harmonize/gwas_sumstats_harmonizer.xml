<?xml version="1.0"?>
<tool id="gwas_sumstats_harmonizer" name="GWAS Sumstats Harmoniser (Nextflow)" version="1.0.8">
  <description>
    Automates cloning/updating the GWAS harmoniser repository and running harmonisation on GWAS summary statistics.
  </description>

  <requirements>
    <requirement type="package" version="3">python</requirement>
    <requirement type="package">git</requirement>
    <requirement type="package">curl</requirement>
    <requirement type="package">tar</requirement>
    <requirement type="package">pandas</requirement>
  </requirements>

  <command detect_errors="exit_code"><![CDATA[
python3 '$__tool_directory__/gwas_sumstats_harmonizer.py'
  --input '$sumstats'
  --build '$build'
  --threshold '$threshold'
  --ref-dir '$ref_dir'
  --repo-url '$repo_url'
  --repo-dir '$repo_dir'
  --workdir '.'
2>&1
]]></command>

  <inputs>
    <!-- Input GWAS dataset -->
    <param name="sumstats" type="data" format="txt,tsv,tabular" label="Input GWAS summary statistics"
           help="Upload your GWAS summary statistics file (tab-delimited text)"/>

    <!-- Genome build -->
    <param name="build" type="select" label="Input genome build">
      <option value="GRCh37">GRCh37 (b37/hg19)</option>
      <option value="GRCh38">GRCh38 (b38/hg38)</option>
    </param>

    <!-- Palindromic threshold -->
    <param name="threshold" type="float" value="0.99" min="0.0" max="1.0" label="Palindromic threshold"
           help="Threshold for handling palindromic SNPs (default 0.99)"/>

    <!-- Reference directory -->
    <param name="ref_dir" type="text" value="/mnt/hdd_1/ofgeha/gwas-ref"
           label="Reference directory (absolute path)" help="Writable directory for reference data">
      <validator type="empty_field" message="Reference directory is required"/>
    </param>

    <!-- Harmoniser repo -->
    <param name="repo_url" type="text" value="https://github.com/EBISPOT/gwas-sumstats-harmoniser.git"
           label="Harmoniser repository URL" help="Git repository to clone or update"/>

    <param name="repo_dir" type="text" value="gwas-sumstats-harmoniser"
           label="Local repository folder" help="Directory to clone repository or reuse existing"/>

  </inputs>

  <outputs>
    <data name="output_tar" format="tar.gz" from_work_dir="harmonizer_output.tar.gz"
          label="Harmoniser raw output (tar.gz)"/>
    <data name="tabular_output" format="tsv" from_work_dir="harmonized_tabular_*.tsv"
          label="Harmonised tabular data">
      <filter>tabular_output is not None</filter>
    </data>
    <data name="run_log" format="txt" from_work_dir="harmonizer_run.log"
          label="Combined stdout/stderr log"/>
    <data name="nextflow_report" format="html" from_work_dir="harmonizer_run_work/harm-report.html"
          label="Nextflow run report"/>
  </outputs>

  <help>
<![CDATA[
**GWAS Summary Statistics Harmoniser**

This tool now provides both:
1. **Raw harmonized output** (tar.gz) - Contains all files from the harmonization process
2. **Tabular harmonized data** (TSV) - Extracted and converted harmonized summary statistics in tabular format

The harmonization process includes:
- Genome build conversion
- Strand alignment
- Quality control
- Metadata generation
]]>
  </help>
</tool>