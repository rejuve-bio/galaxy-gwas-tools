<tool id="calculate_ld_matrix" name="Calculate LD Matrix" version="1.0.3">
    <description>2 Calculates an LD matrix for a genomic region using PLINK</description>

    <requirements>
        <requirement type="package" version="2.1.0">pandas</requirement>
        <!-- We still need PLINK, but your Python script will find it -->
    </requirements>

    <stdio>
        <exit_code range="1:" level="fatal" description="Error calculating LD matrix. See log for details." />
    </stdio>

    <command detect_errors="exit_code"><![CDATA[
        mkdir -p plink_ref &&
        ln -sf '$plink_bed' "plink_ref/${population}.${chromosome}.bed" &&
        ln -sf '$plink_bim' "plink_ref/${population}.${chromosome}.bim" &&
        ln -sf '$plink_fam' "plink_ref/${population}.${chromosome}.fam" &&

        python3 "$__tool_directory__/calculate_ld_matrix.py"
            --sumstats "$sumstats_file"
            --plink_ref_dir "plink_ref"
            --chromosome $chromosome
            --lead_variant "$lead_variant"
            --window $window
            --population "$population"
            --output_ld "$output_ld"
            --output_snps "$output_snps"
    ]]></command>

    

    <inputs>
        <param name="sumstats_file" type="data" format="tsv" label="Summary Statistics with IDs"/>
        <param name="plink_bed" type="data" format="binary" label="PLINK BED file"/>
        <param name="plink_bim" type="data" format="tabular" label="PLINK BIM file"/>
        <param name="plink_fam" type="data" format="tabular" label="PLINK FAM file"/>
        <param name="chromosome" type="integer" value="22" label="Chromosome of Reference Panel"/>
        <param name="lead_variant" type="text" label="Lead Variant ID"/>
        <param name="window" type="integer" value="500" label="Window Size (in kb)"/>
        <param name="population" type="text" value="EUR" label="Population Prefix"/>
    </inputs>

    <outputs>
        <!-- Use 'data' for the compressed binary output -->
        <data name="output_ld" format="tabular" label="${tool.name}: LD Matrix"/>
        <!-- Use 'tabular' for the simple text list of SNPs -->
        <data name="output_snps" format="tabular" label="${tool.name}: SNP List"/>
    </outputs>

    <help>
        This tool calculates the Linkage Disequilibrium (LD) matrix for a group of SNPs in a specific genomic region.
    </help>
</tool>
