<?xml version="1.0"?>
<tool id="gwas_sumstats_harmonizer" name="GWAS Sumstats Harmoniser" version="1.1.0">
  <description>
    Comprehensive harmonization with output analysis and tabular conversion.
  </description>

  <requirements>
    <requirement type="package" version="3">python</requirement>
    <requirement type="package">git</requirement>
    <requirement type="package">curl</requirement>
    <requirement type="package">tar</requirement>
    <requirement type="package">pandas</requirement>
  </requirements>

  <command detect_errors="exit_code"><![CDATA[
python3 '$__tool_directory__/gwas_sumstats_harmonizer.py'
  --input '$sumstats'
  --build '$build'
  --threshold '$threshold'
  --ref-dir '$ref_dir'
  --repo-url '$repo_url'
  --repo-dir '$repo_dir'
  --workdir '.'
2>&1
]]></command>

  <inputs>
    <!-- Input GWAS dataset -->
    <param name="sumstats" type="data" format="txt,tsv,tabular" label="Input GWAS summary statistics"
           help="Upload your GWAS summary statistics file (tab-delimited text)"/>

    <!-- Genome build -->
    <param name="build" type="select" label="Input genome build">
      <option value="GRCh37">GRCh37 (b37/hg19)</option>
      <option value="GRCh38">GRCh38 (b38/hg38)</option>
    </param>

    <!-- Palindromic threshold -->
    <param name="threshold" type="float" value="0.99" min="0.0" max="1.0" label="Palindromic threshold"
           help="Threshold for handling palindromic SNPs (default 0.99)"/>

    <!-- Reference directory -->
    <param name="ref_dir" type="text" value="/mnt/hdd_1/ofgeha/gwas-ref"
           label="Reference directory (absolute path)" help="Writable directory for reference data">
      <validator type="empty_field" message="Reference directory is required"/>
    </param>

    <!-- Harmoniser repo -->
    <param name="repo_url" type="text" value="https://github.com/EBISPOT/gwas-sumstats-harmoniser.git"
           label="Harmoniser repository URL" help="Git repository to clone or update"/>

    <param name="repo_dir" type="text" value="gwas-sumstats-harmoniser"
           label="Local repository folder" help="Directory to clone repository or reuse existing"/>

  </inputs>

  <outputs>
    <data name="output_tar" format="tar.gz" from_work_dir="harmonizer_output.tar.gz"
          label="Harmoniser raw output (tar.gz)"/>
    <data name="analysis_report" format="txt" from_work_dir="output_analysis_report.txt"
          label="Output structure analysis"/>
    <data name="tabular_output" format="tsv" from_work_dir="harmonized_gwas_data.tsv"
          label="Harmonised tabular data">
      <filter>tabular_output is not None</filter>
    </data>
    <data name="run_log" format="txt" from_work_dir="harmonizer_run.log"
          label="Combined stdout/stderr log"/>
    <data name="nextflow_report" format="html" from_work_dir="harmonizer_run_work/harm-report.html"
          label="Nextflow run report"/>
  </outputs>

  <help>
<![CDATA[
**GWAS Summary Statistics Harmoniser - Comprehensive Version**

This version provides:
1. **Raw harmonized output** (tar.gz) - Complete output from harmonization
2. **Output structure analysis** - Detailed report of where files are located
3. **Tabular harmonized data** (TSV) - Attempts to extract and convert main harmonized file
4. **Execution logs and reports** - Full workflow documentation

The analysis report will help identify where harmonized data is stored if automatic extraction fails.
]]>
  </help>
</tool>